<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DocNest Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles/admin_style.css"/>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

</head>
<body>
  <div id="toast-container"></div>
  <div class="container mx-auto p-4 md:p-8">
    <header
      class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4"
    >
      <div class="flex">
        <img
          id="docnest-logo"
          src="https://niveussolutions.com/wp-content/uploads/2025/02/Niveus-ntt-data.png"
          alt="DocNest Logo"
          class="h-12 w-auto mr-3 pt-2"
        />
        <h1
          class="text-4xl sm:text-4xl font-bold tracking-tight text-[var(--text-card-header)]"
        >
          DocNest Admin
        </h1>
      </div>
      <div class="header-controls flex items-center gap-4 ml-auto">
        <input
          type="search"
          id="search-tree-input"
          class="input-field flex-grow max-w-xs sm:max-w-sm md:max-w-md"
          placeholder="Search folders/files..."
        />
        <button
          id="theme-toggle-button"
          class="p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-[var(--border-input-focus)] flex-shrink-0"
          title="Toggle Theme"
        ></button>

        <div class="user-menu-container">
          <button
            id="user-menu-button"
            type="button"
            aria-expanded="false"
            aria-haspopup="true"
          >
            <span id="user-display-name" class="text-sm font-medium"
              >User</span
            >
            <svg
              class="h-5 w-5 text-[var(--text-tertiary)]"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
              aria-hidden="true"
            >
              <path
                fill-rule="evenodd"
                d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.29a.75.75 0 01.02-1.06z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
          <div
            id="user-dropdown-menu"
            class="absolute right-0 mt-2 w-64 origin-top-right rounded-md bg-[var(--bg-dropdown-menu)] shadow-lg ring-1 ring-[var(--border-dropdown-menu)] ring-opacity-5 focus:outline-none hidden"
            role="menu"
            aria-orientation="vertical"
            aria-labelledby="user-menu-button"
          >
            <div class="py-1" role="none">
              <div class="px-4 py-3 border-b border-[var(--border-primary)]">
                <p
                  class="text-sm font-semibold text-[var(--text-primary)]"
                  id="dropdown-user-name"
                >
                  User Name
                </p>
                <p
                  class="text-xs text-[var(--text-secondary)] truncate"
                  id="dropdown-user-email"
                >
                  user@example.com
                </p>
              </div>
              <button
                id="logout-button-dropdown"
                class="block w-full px-4 py-2 text-left text-sm text-[var(--text-red-accent)] hover:bg-[var(--bg-card-hover)]"
                role="menuitem"
              >
                Logout
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-[1800px] mx-auto">
      <!-- Left Column -->
      <div class="space-y-8">
        <!-- Folder Structure Card -->
        <div class="card p-6 shadow-2xl hover:shadow-3xl transition-shadow duration-300">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold card-header flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[var(--text-yellow-accent)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
              Folder Structure
            </h2>
            <button
              onclick="promptNewRoot()"
              class="action-icon-btn add text-2xl hover:scale-110 transition-transform"
              title="Add New Root Folder"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 4v16m8-8H4"
                />
              </svg>
            </button>
          </div>
          <div id="tree-container" class="max-h-[calc(100vh-350px)] overflow-y-auto rounded-lg border border-[var(--border-primary)] bg-[var(--bg-card)]">
            <div id="tree" class="tree-root space-y-0.5 p-2"></div>
          </div>
        </div>

        <!-- Add User Card -->
        <div class="card p-6 shadow-2xl hover:shadow-3xl transition-shadow duration-300">
          <h2 class="text-2xl font-bold card-header mb-6 flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[var(--text-green-accent)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
            </svg>
            Add New User
          </h2>
          <form id="addUserForm" class="space-y-6">
            <div>
              <label for="newUserEmail" class="label-text"
                >Email Address</label
              >
              <input
                type="email"
                id="newUserEmail"
                required
                class="input-field"
                placeholder="user@example.com"
              />
            </div>
            <div>
              <label for="newUserRole" class="label-text"
                >Assign Global Role</label
              >
              <select id="newUserRole" class="input-field">
                <option value="ADMIN">ADMIN</option>
                <option value="EDITOR">EDITOR</option>
                <option value="VIEWER">VIEWER</option>
              </select>
            </div>
            <div>
              <label for="newUserNodeAccess" class="label-text"
                >Grant Initial Node Access (Optional)</label
              >
              <select id="newUserNodeAccess" class="input-field">
                <option value="">None - Global Role Only</option>
              </select>
            </div>

            <div class="flex items-center mt-1 mb-3">
              <input
                type="checkbox"
                id="applyGlobalRoleToAllNodesCheckbox"
                class="h-4 w-4 text-[var(--text-link-hover)] border-[var(--border-input)] rounded focus:ring-[var(--text-link-hover)] mr-2"
              />
              <label
                for="applyGlobalRoleToAllNodesCheckbox"
                class="label-text !mb-0 !font-normal text-sm"
              >
                Apply global role to all nodes (if 'None' selected above)
              </label>
            </div>
            <div>
              <label for="newUserNodeRole" class="label-text"
                >Role for Selected Node</label
              >
              <select id="newUserNodeRole" class="input-field">
                <option value="ADMIN">ADMIN</option>
                <option value="EDITOR">EDITOR</option>
                <option value="VIEWER">VIEWER</option>
              </select>
            </div>
            <button type="submit" class="submit-button w-full sm:w-auto">
              <span class="button-text">Add User</span>
            </button>
          </form>
        </div>
      </div>

      <!-- Right Column -->
      <div class="space-y-8">
        <!-- Activity Log Card -->
        <div class="card p-6 shadow-2xl hover:shadow-3xl transition-shadow duration-300">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold card-header flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[var(--text-blue-accent)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
              Activity Log
            </h2>
            <button
              onclick="fetchActivity(true)" 
              class="action-icon-btn text-xl hover:scale-110 transition-transform" 
              title="Refresh Activity Log"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15" />
              </svg>
            </button>
          </div>
          <div id="activity-container" class="max-h-[calc(100vh-350px)] overflow-y-auto rounded-lg border border-[var(--border-primary)] bg-[var(--bg-card)]">
            <div id="activity-list-initial-spinner" class="text-center py-6">
              <div class="inline-block w-8 h-8 border-4 border-[var(--border-primary)] border-t-[var(--text-link-hover)] rounded-full animate-spin"></div>
              <p class="text-[var(--text-secondary)] mt-2">Loading Activity...</p>
            </div>
            <ul id="activityList" class="space-y-1 p-2"></ul>
            <div id="activity-list-message-area" class="text-center text-[var(--text-tertiary)] py-4 hidden"></div>
          </div>
        </div>

        <!-- All Users Card -->
        <div class="card p-6 shadow-2xl hover:shadow-3xl transition-shadow duration-300">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b border-[var(--border-primary)] pb-4">
            <h2 class="text-2xl font-bold card-header flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[var(--text-purple-accent)]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
              </svg>
              All Users
            </h2>
          </div>

          <div class="mb-4">
            <input 
              type="search" 
              id="search-users-input" 
              class="input-field w-full rounded-lg shadow-sm focus:shadow-md transition-shadow" 
              placeholder="Search users by email..." 
            />
          </div>

          <div id="userListContainer" class="max-h-[calc(100vh-350px)] overflow-y-auto rounded-lg border border-[var(--border-primary)] bg-[var(--bg-card)]">
            <div
              id="user-list-initial-spinner"
              class="text-center py-6 hidden"
            >
              <div
                class="inline-block w-10 h-10 border-4 border-[var(--border-primary)] border-t-[var(--text-link-hover)] rounded-full animate-spin"
              ></div>
              <p class="text-[var(--text-secondary)] mt-3">
                Loading Users...
              </p>
            </div>

            <ul id="userList" class="space-y-3"></ul>
            <div
              id="user-list-loading-indicator"
              class="text-center py-4 hidden"
            >
              <div
                class="inline-block w-8 h-8 border-2 border-[var(--border-primary)] border-t-[var(--text-link-hover)] rounded-full animate-spin"
              ></div>
            </div>

            <div
              id="user-list-message-area"
              class="text-center text-[var(--text-tertiary)] py-6 hidden"
            ></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="access-management-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          Manage Access for
          <span id="modal-user-email" class="font-mono"></span>
        </h3>
        <button class="modal-close-btn" onclick="closeAccessModal()">
          &times;
        </button>
      </div>
      <input type="hidden" id="modal-editing-user-email-hidden" />

      <h4 class="text-lg font-semibold mb-2 text-[var(--text-secondary)]">
        Current Node Access:
      </h4>
      <div
        id="access-management-modal-current-access"
        class="mb-6 space-y-0 border border-[var(--border-primary)] rounded-md"
      >
        <p class="text-[var(--text-tertiary)] p-3">Loading access...</p>
      </div>

      <h4 class="text-lg font-semibold mb-3 text-[var(--text-secondary)]">
        Grant New Node Access:
      </h4>
      <form
        id="grantNewAccessForm"
        class="space-y-4 p-4 border border-[var(--border-primary)] rounded-md bg-[var(--bg-inline-form)]"
      >
        <div>
          <label for="modalNodeSelect" class="label-text"
            >Select Folder/File</label
          >
          <select id="modalNodeSelect" class="input-field">
            <option value="">-- Select Node --</option>
          </select>
        </div>
        <div>
          <label for="modalNodeRoleSelect" class="label-text"
            >Assign Role</label
          >
          <select id="modalNodeRoleSelect" class="input-field">
            <option value="ADMIN">ADMIN</option>
            <option value="EDITOR">EDITOR</option>
            <option value="VIEWER">VIEWER</option>
          </select>
        </div>
        <button
          type="submit"
          class="submit-button secondary w-full sm:w-auto"
        >
          <span class="button-text">Grant Access</span>
        </button>
      </form>
      <div class="mt-6 text-right">
        <button class="submit-button secondary" onclick="closeAccessModal()">
          <span class="button-text">Close</span>
        </button>
      </div>
    </div>
  </div>

  <div id="artifact-details-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="artifact-modal-title" class="modal-title">
          Artifact Details
        </h3>
        <button class="modal-close-btn" onclick="closeArtifactDetailsModal()">
          &times;
        </button>
      </div>

      <div class="mb-4">
        <label class="label-text">Description:</label>
        <div
          id="artifact-details-modal-description"
          class="p-3 border border-[var(--border-input)] rounded-md bg-[var(--bg-input)] text-sm min-h-[60px]"
        >
          No description provided.
        </div>
      </div>

      <div class="mt-6 text-right space-x-3">
        <a
          id="artifact-modal-link"
          href="#"
          target="_blank"
          class="submit-button inline-block"
        >
          Go to Resource
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 inline-block ml-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
            />
          </svg>
        </a>
        <button
          class="submit-button secondary"
          onclick="closeArtifactDetailsModal()"
        >
          <span class="button-text">Close</span>
        </button>
      </div>
    </div>
  </div>

  <div id="delete-confirmation-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="delete-modal-title" class="modal-title">Confirm Deletion</h3>
        <button
          class="modal-close-btn"
          onclick="closeDeleteConfirmationModal()"
        >
          &times;
        </button>
      </div>
      <p id="delete-modal-message" class="mb-4 text-[var(--text-secondary)]">
        Are you sure you want to delete this item? This action cannot be
        undone.
      </p>
      <div class="mb-4">
        <label for="delete-confirm-input" class="label-text"
          >To confirm, type "DELETE" in the box below:</label
        >
        <input
          type="text"
          id="delete-confirm-input"
          class="input-field"
          placeholder="DELETE"
        />
      </div>
      <div class="mt-6 text-right space-x-3">
        <button
          class="submit-button secondary"
          onclick="closeDeleteConfirmationModal()"
        >
          <span class="button-text">Cancel</span>
        </button>
        <button
          id="confirm-delete-button"
          class="submit-button destructive"
          disabled
        >
          <span class="button-text">Delete</span>
        </button>
      </div>
    </div>
  </div>

  <script src="scripts/admin_script.js" type="module"></script>
</body>
</html>